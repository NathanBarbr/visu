<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiérarchie des Cultures — RPG 2023</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-dark: #1c1c1e;
            --card-bg: #2c2c2e;
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --text-muted: #86868b;
            --border: #3a3a3c;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            position: relative;
        }

        .back-link {
            position: absolute;
            top: 0;
            left: 0;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--text-primary);
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-top: 20px;
        }

        h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 3rem;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .instruction {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 16px;
            padding: 12px 20px;
            background: var(--card-bg);
            border-radius: 8px;
            display: inline-block;
        }

        .instruction span {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Chart */
        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
        }

        #sunburst {
            position: relative;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            padding: 8px 16px;
            background: var(--card-bg);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .breadcrumb-item:hover {
            background: #3a3a3c;
            color: var(--text-primary);
        }

        .breadcrumb-item.active {
            background: #0a84ff;
            color: white;
        }

        .breadcrumb-arrow {
            color: var(--text-muted);
            display: flex;
            align-items: center;
        }

        /* Info panel */
        .info-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
            max-width: 200px;
        }

        .info-label {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .info-value {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 1.8rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .info-surface {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Tooltip */
        #tooltip {
            position: fixed;
            pointer-events: none;
            background: var(--card-bg);
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            max-width: 280px;
        }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 4px;
        }

        .tooltip-label {
            color: var(--text-muted);
        }

        .tooltip-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 16px;
            margin-top: 30px;
            max-width: 900px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--card-bg);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .legend-item:hover {
            background: #3a3a3c;
            color: var(--text-primary);
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .info-value {
                font-size: 1.4rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="index.html" class="back-link">← Retour au menu</a>

        <header>
            <h1>Hiérarchie des Cultures</h1>
            <div class="subtitle">Explorez la hiérarchie des cultures françaises — du groupe à la parcelle</div>
            <div class="instruction">
                <span>Cliquez</span> sur un segment pour zoomer · <span>Centre</span> pour revenir
            </div>
        </header>

        <div class="breadcrumb" id="breadcrumb"></div>

        <div class="chart-container">
            <div id="sunburst">
                <div class="info-panel" id="info-panel">
                    <div class="info-label">France</div>
                    <div class="info-value" id="info-value">100%</div>
                    <div class="info-surface" id="info-surface">Surface totale</div>
                </div>
            </div>
        </div>

        <div class="legend" id="legend"></div>
    </div>

    <div id="tooltip"></div>

    <script>
        // Group labels and colors
        const GROUP_INFO = {
            "1": { label: "Blé tendre", color: "#ffd60a" },
            "2": { label: "Maïs", color: "#ff9f0a" },
            "3": { label: "Orge", color: "#ffcc00" },
            "4": { label: "Autres céréales", color: "#e6b800" },
            "5": { label: "Colza", color: "#ffe620" },
            "6": { label: "Tournesol", color: "#ffb340" },
            "7": { label: "Soja & autres oléagineux", color: "#ff9500" },
            "8": { label: "Protéagineux", color: "#bf5af2" },
            "9": { label: "Plantes à fibres", color: "#af52de" },
            "11": { label: "Jachères", color: "#636366" },
            "14": { label: "Riz", color: "#30d158" },
            "15": { label: "Légumineuses", color: "#34c759" },
            "16": { label: "Fourrages", color: "#32d74b" },
            "17": { label: "Surfaces pastorales", color: "#63e086" },
            "18": { label: "Prairies permanentes", color: "#30d158" },
            "19": { label: "Prairies temporaires", color: "#28cd50" },
            "20": { label: "Vergers", color: "#ff6482" },
            "21": { label: "Vignes", color: "#bf5af2" },
            "22": { label: "Fruits à coque", color: "#8b5a2b" },
            "23": { label: "Oliviers", color: "#708238" },
            "24": { label: "Divers", color: "#48484a" },
            "25": { label: "Légumes", color: "#ff6b6b" },
            "28": { label: "Non productif", color: "#3a3a3c" }
        };

        const CODE_LABELS = {
            "PPH": "Prairies permanentes", "SPH": "Surface pastorale", "BTH": "Blé tendre",
            "MIS": "Maïs grain", "PTR": "Prairie temporaire", "ORH": "Orge d'hiver",
            "TTH": "Triticale", "TRN": "Tournesol", "CZH": "Colza d'hiver",
            "MLG": "Mélange Gram/Légu", "LUZ": "Luzerne", "VRC": "Vignes à raisins",
            "JAC": "Jachère", "SOJ": "Soja", "SNE": "Non exploité",
            "NOX": "Noyer", "VRG": "Verger", "SGH": "Seigle d'hiver",
            "BTP": "Blé détruit", "LIH": "Lin", "SPL": "Surf. pasto. ligneuse",
            "BOR": "Bordures", "OLI": "Oliviers", "MDI": "Maïs doux",
            "MIE": "Maïs ensilage", "ORP": "Orge printemps", "PRL": "Prairies longue durée",
            "BDH": "Blé dur hiver", "RGA": "Ray-grass anglais", "FVL": "Féverole",
            "BOP": "Bois et landes pastoraux", "PTC": "Pomme de terre", "BTN": "Betterave",
            "BTA": "Bâtiments agricoles", "J5M": "Jachère 5 ans", "J6S": "Jachère 6 ans SIE"
        };

        function getLabel(code, isGroup = false) {
            if (isGroup && GROUP_INFO[code]) return GROUP_INFO[code].label;
            return CODE_LABELS[code] || code;
        }

        // Chart dimensions
        const width = Math.min(700, window.innerWidth - 40);
        const height = width;
        const radius = width / 2;

        let currentRoot = null;

        async function init() {
            try {
                const response = await fetch('data_hierarchy_france.json');
                const data = await response.json();

                // Transform data for sunburst
                const root = d3.hierarchy(data)
                    .sum(d => d.value || 0)
                    .sort((a, b) => b.value - a.value);

                currentRoot = root;

                // Create partition layout
                const partition = d3.partition()
                    .size([2 * Math.PI, radius]);

                partition(root);

                renderSunburst(root);
                renderLegend();
                updateBreadcrumb([{ name: "France", data: root }]);

            } catch (e) {
                console.error("Error loading data:", e);
            }
        }

        function renderSunburst(root) {
            const svg = d3.select("#sunburst")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);

            const arc = d3.arc()
                .startAngle(d => d.x0)
                .endAngle(d => d.x1)
                .padAngle(0.002)
                .padRadius(radius / 2)
                .innerRadius(d => d.y0)
                .outerRadius(d => d.y1 - 1);

            const color = d3.scaleOrdinal()
                .domain(Object.keys(GROUP_INFO))
                .range(Object.values(GROUP_INFO).map(g => g.color));

            const path = svg.selectAll("path")
                .data(root.descendants().filter(d => d.depth))
                .join("path")
                .attr("fill", d => {
                    // Use parent's color for children
                    let node = d;
                    while (node.depth > 1) node = node.parent;
                    return GROUP_INFO[node.data.name]?.color || "#636366";
                })
                .attr("fill-opacity", d => d.depth === 1 ? 1 : 0.7)
                .attr("d", arc)
                .style("cursor", "pointer")
                .on("click", (event, d) => clicked(event, d, root, arc, svg, path))
                .on("mouseover", (event, d) => showTooltip(event, d, root))
                .on("mousemove", moveTooltip)
                .on("mouseout", hideTooltip);

            // Add labels for large segments
            svg.selectAll("text")
                .data(root.descendants().filter(d => d.depth && (d.x1 - d.x0) > 0.1))
                .join("text")
                .attr("transform", d => {
                    const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
                    const y = (d.y0 + d.y1) / 2;
                    return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
                })
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .attr("fill", "#1c1c1e")
                .attr("font-size", d => d.depth === 1 ? "11px" : "9px")
                .attr("font-weight", d => d.depth === 1 ? "600" : "400")
                .style("pointer-events", "none")
                .text(d => {
                    const label = getLabel(d.data.name, d.depth === 1);
                    return label.length > 12 ? label.substring(0, 10) + "..." : label;
                });

            // Center circle for "back" action
            svg.append("circle")
                .attr("r", radius * 0.15)
                .attr("fill", "var(--card-bg)")
                .attr("stroke", "var(--border)")
                .attr("stroke-width", 2)
                .style("cursor", "pointer")
                .on("click", () => {
                    // Reset to root
                    const t = svg.transition().duration(750);
                    path.transition(t)
                        .attrTween("d", d => () => arc(d));
                    updateInfoPanel(root);
                    updateBreadcrumb([{ name: "France", data: root }]);
                });
        }

        function clicked(event, p, root, arc, svg, path) {
            // Update info panel
            updateInfoPanel(p);

            // Update breadcrumb
            const ancestors = p.ancestors().reverse();
            const breadcrumbData = ancestors.map(d => ({
                name: d.depth === 0 ? "France" : getLabel(d.data.name, d.depth === 1),
                data: d
            }));
            updateBreadcrumb(breadcrumbData);

            // Zoom animation
            root.each(d => {
                d.target = {
                    x0: Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
                    x1: Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
                    y0: Math.max(0, d.y0 - p.y0),
                    y1: Math.max(0, d.y1 - p.y0)
                };
            });

            const t = svg.transition().duration(750);

            path.transition(t)
                .tween("data", d => {
                    const i = d3.interpolate(d.current, d.target);
                    return t => d.current = i(t);
                })
                .attrTween("d", d => () => arc(d.current));

            path.each(function (d) { d.current = d; });
        }

        function updateInfoPanel(d) {
            const panel = document.getElementById('info-panel');
            const total = currentRoot.value;
            const pct = ((d.value / total) * 100).toFixed(1);

            const label = d.depth === 0 ? "France" : getLabel(d.data.name, d.depth === 1);

            document.querySelector('.info-label').textContent = label;
            document.getElementById('info-value').textContent = pct + "%";
            document.getElementById('info-surface').textContent =
                Math.round(d.value).toLocaleString() + " ha";
        }

        function updateBreadcrumb(items) {
            const container = document.getElementById('breadcrumb');
            container.innerHTML = '';

            items.forEach((item, i) => {
                if (i > 0) {
                    const arrow = document.createElement('span');
                    arrow.className = 'breadcrumb-arrow';
                    arrow.textContent = '›';
                    container.appendChild(arrow);
                }

                const el = document.createElement('span');
                el.className = 'breadcrumb-item' + (i === items.length - 1 ? ' active' : '');
                el.textContent = item.name;
                el.onclick = () => updateInfoPanel(item.data);
                container.appendChild(el);
            });
        }

        function renderLegend() {
            const legend = document.getElementById('legend');

            // Show top groups
            const mainGroups = ["18", "1", "2", "3", "5", "6", "17", "21", "25", "11"];

            mainGroups.forEach(code => {
                const info = GROUP_INFO[code];
                if (!info) return;

                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background: ${info.color}"></div>
                    <span>${info.label}</span>
                `;
                legend.appendChild(item);
            });
        }

        const tooltip = document.getElementById('tooltip');

        function showTooltip(event, d, root) {
            const total = root.value;
            const pct = ((d.value / total) * 100).toFixed(2);
            const label = getLabel(d.data.name, d.depth === 1);
            const count = d.data.count ? d.data.count.toLocaleString() :
                d.leaves().reduce((sum, l) => sum + (l.data.count || 0), 0).toLocaleString();

            tooltip.innerHTML = `
                <div class="tooltip-title">${label}</div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Surface:</span>
                    <span class="tooltip-value">${Math.round(d.value).toLocaleString()} ha</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Part:</span>
                    <span class="tooltip-value">${pct}%</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Parcelles:</span>
                    <span class="tooltip-value">${count}</span>
                </div>
            `;
            tooltip.style.opacity = '1';
            moveTooltip(event);
        }

        function moveTooltip(event) {
            tooltip.style.left = (event.clientX + 15) + 'px';
            tooltip.style.top = (event.clientY - 10) + 'px';
        }

        function hideTooltip() {
            tooltip.style.opacity = '0';
        }

        init();
    </script>
</body>

</html>