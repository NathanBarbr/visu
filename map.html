<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte RPG France - Visualisation Interactive</title>
    <meta name="description"
        content="Carte interactive des parcelles agricoles en France - Registre Parcellaire Graphique">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Turf.js pour les calculs géographiques -->
    <script src="turf.min.js"></script>

    <style>
        :root {
            --bg-dark: #1c1c1e;
            --card-bg: #2c2c2e;
            --card-bg-hover: #3a3a3c;
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --text-muted: #86868b;
            --accent: #0a84ff;
            --accent-hover: #409cff;
            --success: #30d158;
            --warning: #ffd60a;
            --danger: #ff453a;
            --border: #3a3a3c;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: var(--bg-dark);
            color: var(--text-primary);
        }

        /* Sidebar */
        #sidebar {
            width: 360px;
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 2000;
            box-shadow: var(--shadow);
        }

        .sidebar-header {
            padding: 24px;
            background: linear-gradient(180deg, var(--card-bg) 0%, transparent 100%);
            border-bottom: 1px solid var(--border);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 16px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--accent);
        }

        .sidebar-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 1.4rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .sidebar-subtitle {
            color: var(--text-muted);
            font-size: 13px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
        }

        /* Control Groups */
        .control-group {
            margin-bottom: 24px;
        }

        .control-label {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: block;
        }

        /* Search Box */
        .search-container {
            display: flex;
            gap: 8px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-btn {
            padding: 12px 20px;
            background: var(--gradient-1);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* City Chips */
        .city-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .chip {
            background: var(--bg-dark);
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }

        .chip:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        /* Region Filter */
        .region-list {
            max-height: 280px;
            overflow-y: auto;
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--border);
        }

        .region-list::-webkit-scrollbar {
            width: 6px;
        }

        .region-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .region-list::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 3px;
        }

        .region-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .region-item:hover {
            background: var(--card-bg);
        }

        .region-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .region-item label {
            font-size: 13px;
            color: var(--text-primary);
            cursor: pointer;
            flex: 1;
        }

        .region-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .region-action-btn {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .region-action-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Stats Panel */
        .stats-panel {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .stat-value {
            font-weight: 600;
            font-size: 14px;
            color: var(--accent);
        }

        .stat-value.success {
            color: var(--success);
        }

        .stat-value.warning {
            color: var(--warning);
        }

        /* Loading States */
        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .loading-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--accent);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: var(--accent);
            font-size: 13px;
        }

        .hidden {
            display: none !important;
        }

        /* Map Container */
        #map {
            flex-grow: 1;
            height: 100%;
            background: var(--bg-dark);
        }

        /* Leaflet Customization */
        .leaflet-popup-content-wrapper {
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .leaflet-popup-tip {
            background: var(--card-bg);
        }

        .leaflet-popup-content {
            margin: 12px 16px;
            font-family: 'Inter', sans-serif;
        }

        .popup-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .popup-info {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .popup-info strong {
            color: var(--text-primary);
        }

        .leaflet-control-zoom {
            border: none !important;
            box-shadow: var(--shadow) !important;
        }

        .leaflet-control-zoom a {
            background: var(--card-bg) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border) !important;
        }

        .leaflet-control-zoom a:hover {
            background: var(--card-bg-hover) !important;
        }

        /* Legend */
        .legend {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            margin-top: 12px;
        }

        .legend-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 4px 0;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-label {
            font-size: 12px;
            color: var(--text-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            #sidebar {
                width: 100%;
                height: auto;
                max-height: 50vh;
            }

            body {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <div class="sidebar-header">
            <a href="index.html" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
                Retour au menu
            </a>
            <h1 class="sidebar-title">Carte RPG France</h1>
            <p class="sidebar-subtitle">Visualisation des parcelles agricoles</p>
        </div>

        <div class="sidebar-content">
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="loading-indicator">
                <div class="loading-spinner"></div>
                <span class="loading-text">Chargement des données...</span>
            </div>

            <!-- Search -->
            <div class="control-group">
                <label class="control-label">Rechercher une ville</label>
                <div class="search-container">
                    <input type="text" id="city-search" class="search-input" placeholder="Ex: Lyon, Toulouse..."
                        onkeypress="handleEnter(event)">
                    <button class="search-btn" onclick="searchCity()">Go</button>
                </div>
                <div class="city-chips">
                    <div class="chip" onclick="flyTo(48.8566, 2.3522, 11)">Paris</div>
                    <div class="chip" onclick="flyTo(45.7640, 4.8357, 11)">Lyon</div>
                    <div class="chip" onclick="flyTo(43.2965, 5.3698, 11)">Marseille</div>
                    <div class="chip" onclick="flyTo(44.8378, -0.5792, 12)">Bordeaux</div>
                    <div class="chip" onclick="flyTo(47.2184, -1.5536, 12)">Nantes</div>
                    <div class="chip" onclick="flyTo(43.6047, 1.4442, 12)">Toulouse</div>
                </div>
            </div>

            <!-- Region Filter -->
            <div class="control-group">
                <label class="control-label">Filtrer par région</label>
                <div class="region-actions">
                    <button class="region-action-btn" onclick="selectAllRegions(true)">Tout sélectionner</button>
                    <button class="region-action-btn" onclick="selectAllRegions(false)">Tout désélectionner</button>
                </div>
                <div class="region-list" id="region-container">
                    <!-- Checkboxes générées par JS -->
                </div>
            </div>

            <!-- Stats -->
            <div class="control-group">
                <label class="control-label">Statistiques</label>
                <div class="stats-panel">
                    <div class="stat-row">
                        <span class="stat-label">Parcelles affichées</span>
                        <span class="stat-value" id="stat-count">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Mode d'affichage</span>
                        <span class="stat-value success" id="stat-mode">Points</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Zoom actuel</span>
                        <span class="stat-value warning" id="stat-zoom">6</span>
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="legend">
                <div class="legend-title">Légende des cultures</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981;"></div>
                    <span class="legend-label">PPH - Prairies permanentes</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b;"></div>
                    <span class="legend-label">BTH - Blé tendre</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span class="legend-label">MIS - Maïs</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8b5cf6;"></div>
                    <span class="legend-label">VRC - Vigne</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3b82f6;"></div>
                    <span class="legend-label">Autres cultures</span>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // Configuration
        const CONFIG = {
            center: [46.603354, 1.888334],
            initialZoom: 6,
            maxZoom: 18,
            zoomThreshold: 13,
            maxPoints: 5000,
            colors: {
                "PPH": "#10b981",  // Prairies - vert
                "BTH": "#f59e0b",  // Blé - orange
                "MIS": "#ef4444",  // Maïs - rouge
                "VRC": "#8b5cf6",  // Vigne - violet
                "DEFAULT": "#3b82f6"  // Default - bleu
            }
        };

        // Noms des régions françaises
        const REGION_NAMES = [
            "Auvergne-Rhône-Alpes",
            "Bourgogne-Franche-Comté",
            "Bretagne",
            "Centre-Val de Loire",
            "Corse",
            "Grand Est",
            "Hauts-de-France",
            "Île-de-France",
            "Normandie",
            "Nouvelle-Aquitaine",
            "Occitanie",
            "Pays de la Loire",
            "Provence-Alpes-Côte d'Azur",
            "Inconnu"
        ];

        // State
        let map;
        let geojsonLayer;
        let allData = null;
        let regionsGeo = null;
        let allDataOriginalCount = 0;
        let lastZoomMode = 'point';

        // Initialize Map
        function initMap() {
            map = L.map('map', {
                center: CONFIG.center,
                zoom: CONFIG.initialZoom,
                zoomControl: true
            });

            // Fond de carte clair OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: CONFIG.maxZoom
            }).addTo(map);

            // Listen for zoom changes
            map.on('zoomend', handleZoomChange);
            map.on('moveend', updateStats);

            updateZoomStat();
        }

        // Get color for culture type
        function getColor(code) {
            return CONFIG.colors[code] || CONFIG.colors.DEFAULT;
        }

        // Initialize region checkboxes
        function initRegionCheckboxes() {
            const container = document.getElementById('region-container');
            container.innerHTML = '';

            REGION_NAMES.sort().forEach((region, index) => {
                const item = document.createElement('div');
                item.className = 'region-item';
                item.innerHTML = `
                    <input type="checkbox" id="region-${index}" value="${region}" checked onchange="updateFilters()">
                    <label for="region-${index}">${region}</label>
                `;
                container.appendChild(item);
            });
        }

        // Select/Deselect all regions
        function selectAllRegions(select) {
            const checkboxes = document.querySelectorAll('#region-container input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = select);
            updateFilters();
        }

        // Sample features using reservoir sampling
        function sampleFeatures(features, maxCount) {
            if (features.length <= maxCount) return features;

            const result = features.slice(0, maxCount);
            for (let i = maxCount; i < features.length; i++) {
                const j = Math.floor(Math.random() * (i + 1));
                if (j < maxCount) result[j] = features[i];
            }
            return result;
        }

        // Tag parcels with region names
        function tagParcelsWithRegion() {
            if (!allData || !regionsGeo) return;

            let matches = 0;
            allData.features.forEach(feature => {
                try {
                    const center = turf.centroid(feature);
                    let found = false;

                    for (const region of regionsGeo.features) {
                        try {
                            if (turf.booleanPointInPolygon(center, region)) {
                                feature.properties.regionName = region.properties.nom;
                                found = true;
                                matches++;
                                break;
                            }
                        } catch (e) {
                            // Skip invalid geometries
                        }
                    }

                    if (!found) {
                        feature.properties.regionName = "Inconnu";
                    }
                } catch (e) {
                    feature.properties.regionName = "Inconnu";
                }
            });

            console.log(`Région tagging terminé: ${matches}/${allData.features.length} parcelles associées`);
        }

        // Load data
        async function loadData() {
            const loadingIndicator = document.getElementById('loading-indicator');

            try {
                // Load regions and parcels in parallel
                const [regionsResponse, parcelsResponse] = await Promise.all([
                    fetch('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/regions-version-simplifiee.geojson'),
                    fetch('parcels_sample_france_5000.geojson')
                ]);

                if (!regionsResponse.ok) {
                    throw new Error('Erreur lors du chargement des régions');
                }
                if (!parcelsResponse.ok) {
                    throw new Error('Erreur lors du chargement des parcelles');
                }

                regionsGeo = await regionsResponse.json();
                const parcelsData = await parcelsResponse.json();

                allDataOriginalCount = parcelsData.features.length;
                const sampledFeatures = sampleFeatures(parcelsData.features, CONFIG.maxPoints);
                allData = { ...parcelsData, features: sampledFeatures };

                // Tag parcels with regions
                tagParcelsWithRegion();

                // Hide loading indicator
                loadingIndicator.classList.add('hidden');

                // Initial render
                updateFilters();

            } catch (error) {
                console.error('Erreur de chargement:', error);
                loadingIndicator.innerHTML = `
                    <span style="color: var(--danger);">❌ ${error.message}</span>
                `;
            }
        }

        // Handle zoom change
        function handleZoomChange() {
            const zoom = map.getZoom();
            const newMode = zoom >= CONFIG.zoomThreshold ? 'polygon' : 'point';

            updateZoomStat();

            if (newMode !== lastZoomMode) {
                updateFilters();
            }
        }

        // Update stats display
        function updateZoomStat() {
            const zoom = map.getZoom();
            document.getElementById('stat-zoom').textContent = Math.round(zoom);
        }

        // Update filters and redraw
        function updateFilters() {
            if (!allData) return;

            // Get selected regions
            const checkboxes = document.querySelectorAll('#region-container input:checked');
            const selectedRegions = new Set(Array.from(checkboxes).map(cb => cb.value));

            // Determine display mode
            const zoom = map.getZoom();
            const mode = zoom >= CONFIG.zoomThreshold ? 'polygon' : 'point';
            lastZoomMode = mode;

            // Update mode stat
            document.getElementById('stat-mode').textContent = mode === 'point' ? 'Points' : 'Polygones';

            // Remove existing layer
            if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
            }

            // Filter features by region
            const filteredFeatures = allData.features.filter(feature => {
                const regionName = feature.properties.regionName;
                return selectedRegions.has(regionName);
            });

            // TOUJOURS rééchantillonner pour atteindre le quota de 5000 parcelles
            // Cela permet de maintenir un nombre constant même quand on désélectionne des régions
            let featuresToDisplay = filteredFeatures;
            if (filteredFeatures.length > CONFIG.maxPoints) {
                featuresToDisplay = sampleFeatures(filteredFeatures, CONFIG.maxPoints);
            }

            let dataToDisplay;
            let options = {};

            if (mode === 'point') {
                // Convert to centroids for better performance
                const pointsCollection = {
                    type: "FeatureCollection",
                    features: featuresToDisplay.map(f => {
                        try {
                            const center = turf.centroid(f);
                            center.properties = f.properties;
                            return center;
                        } catch (e) {
                            return null;
                        }
                    }).filter(f => f !== null)
                };
                dataToDisplay = pointsCollection;

                // Canvas renderer for performance
                const canvasRenderer = L.canvas({ padding: 0.5 });

                options = {
                    pointToLayer: (feature, latlng) => {
                        return L.circleMarker(latlng, {
                            radius: 4,
                            fillColor: getColor(feature.properties.culture),
                            color: 'rgba(255,255,255,0.3)',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.85,
                            renderer: canvasRenderer
                        });
                    },
                    onEachFeature: bindPopup
                };
            } else {
                // Polygon mode
                dataToDisplay = {
                    type: "FeatureCollection",
                    features: featuresToDisplay
                };

                options = {
                    style: (feature) => ({
                        fillColor: getColor(feature.properties.culture),
                        weight: 2,
                        opacity: 1,
                        color: 'rgba(255,255,255,0.5)',
                        fillOpacity: 0.7
                    }),
                    onEachFeature: bindPopup
                };
            }

            // Create and add layer
            geojsonLayer = L.geoJSON(dataToDisplay, options).addTo(map);

            // Update count stat
            const count = geojsonLayer.getLayers().length;
            document.getElementById('stat-count').textContent = count.toLocaleString('fr-FR');
        }

        // Bind popup and hover effects
        function bindPopup(feature, layer) {
            const p = feature.properties;

            const popupContent = `
                <div class="popup-title">${p.culture || 'Culture inconnue'}</div>
                <div class="popup-info">
                    <strong>Surface:</strong> ${p.surface ? p.surface.toFixed(2) : 'N/A'} ha<br>
                    <strong>Région:</strong> ${p.regionName || 'Inconnue'}<br>
                    <strong>ID:</strong> ${p.id || 'N/A'}
                </div>
            `;

            layer.bindPopup(popupContent);

            // Hover effects
            layer.on('mouseover', function () {
                if (lastZoomMode === 'point') {
                    this.setStyle({
                        radius: 6,
                        fillOpacity: 1,
                        weight: 2,
                        color: 'white'
                    });
                } else {
                    this.setStyle({
                        weight: 3,
                        color: 'white',
                        fillOpacity: 0.9
                    });
                }
                this.bringToFront();
            });

            layer.on('mouseout', function () {
                if (lastZoomMode === 'point') {
                    this.setStyle({
                        radius: 4,
                        fillOpacity: 0.85,
                        weight: 1,
                        color: 'rgba(255,255,255,0.3)'
                    });
                } else {
                    this.setStyle({
                        weight: 2,
                        color: 'rgba(255,255,255,0.5)',
                        fillOpacity: 0.7
                    });
                }
            });
        }

        // Update stats
        function updateStats() {
            updateZoomStat();
        }

        // Navigation functions
        function flyTo(lat, lng, zoom) {
            map.flyTo([lat, lng], zoom, {
                duration: 1.5,
                easeLinearity: 0.25
            });
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                searchCity();
            }
        }

        async function searchCity() {
            const query = document.getElementById('city-search').value.trim();
            if (!query) return;

            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}, France`;
                const response = await fetch(url);
                const results = await response.json();

                if (results.length > 0) {
                    const best = results[0];
                    flyTo(parseFloat(best.lat), parseFloat(best.lon), 12);
                } else {
                    alert('Ville non trouvée. Essayez avec un autre nom.');
                }
            } catch (error) {
                console.error('Erreur de recherche:', error);
                alert('Erreur lors de la recherche. Veuillez réessayer.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initRegionCheckboxes();
            loadData();
        });
    </script>
</body>

</html>