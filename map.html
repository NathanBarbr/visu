<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte RPG France - Visualisation Interactive</title>
    <meta name="description"
        content="Carte interactive des parcelles agricoles en France - Registre Parcellaire Graphique">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">

    <!-- Leaflet JS & Heatmap plugin -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <!-- Turf.js pour les calculs géographiques -->
    <script src="turf.min.js"></script>

    <style>
        :root {
            --bg-dark: #1c1c1e;
            --card-bg: #2c2c2e;
            --card-bg-hover: #3a3a3c;
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --text-muted: #86868b;
            --accent: #0a84ff;
            --accent-hover: #409cff;
            --success: #30d158;
            --warning: #ffd60a;
            --danger: #ff453a;
            --border: #3a3a3c;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: var(--bg-dark);
            color: var(--text-primary);
        }

        /* Sidebar */
        #sidebar {
            width: 360px;
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 2000;
            box-shadow: var(--shadow);
        }

        .sidebar-header {
            padding: 24px;
            background: linear-gradient(180deg, var(--card-bg) 0%, transparent 100%);
            border-bottom: 1px solid var(--border);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 16px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--accent);
        }

        .sidebar-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 1.4rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .sidebar-subtitle {
            color: var(--text-muted);
            font-size: 13px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
        }

        /* Control Groups */
        .control-group {
            margin-bottom: 24px;
        }

        .control-label {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: block;
        }

        /* Search Box */
        .search-container {
            display: flex;
            gap: 8px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-btn {
            padding: 12px 20px;
            background: var(--gradient-1);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* City Chips */
        .city-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .chip {
            background: var(--bg-dark);
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }

        .chip:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        /* Region Filter */
        .region-list {
            max-height: 280px;
            overflow-y: auto;
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--border);
        }

        .region-list::-webkit-scrollbar {
            width: 6px;
        }

        .region-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .region-list::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 3px;
        }

        .region-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .region-item:hover {
            background: var(--card-bg);
        }

        .region-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .region-item label {
            font-size: 13px;
            color: var(--text-primary);
            cursor: pointer;
            flex: 1;
        }

        .region-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .region-action-btn {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .region-action-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Stats Panel */
        .stats-panel {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .stat-value {
            font-weight: 600;
            font-size: 14px;
            color: var(--accent);
        }

        .stat-value.success {
            color: var(--success);
        }

        .stat-value.warning {
            color: var(--warning);
        }

        /* Toggle Switch for Heatmap */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .toggle-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--danger);
            box-shadow: 0 0 8px rgba(255, 69, 58, 0.5);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* Loading States */
        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .loading-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--accent);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: var(--accent);
            font-size: 13px;
        }

        .hidden {
            display: none !important;
        }

        /* Map Container */
        #map {
            flex-grow: 1;
            height: 100%;
            background: var(--bg-dark);
        }

        /* Leaflet Customization */
        .leaflet-popup-content-wrapper {
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .leaflet-popup-tip {
            background: var(--card-bg);
        }

        .leaflet-popup-content {
            margin: 12px 16px;
            font-family: 'Inter', sans-serif;
        }

        .popup-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .popup-info {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .popup-info strong {
            color: var(--text-primary);
        }

        .leaflet-control-zoom {
            border: none !important;
            box-shadow: var(--shadow) !important;
        }

        .leaflet-control-zoom a {
            background: var(--card-bg) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border) !important;
        }

        .leaflet-control-zoom a:hover {
            background: var(--card-bg-hover) !important;
        }

        /* Legend */
        .legend {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            margin-top: 12px;
        }

        .legend-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 4px 0;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-label {
            font-size: 12px;
            color: var(--text-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            #sidebar {
                width: 100%;
                height: auto;
                max-height: 50vh;
            }

            body {
                flex-direction: column;
            }
        }

        /* Top Navigation Bar */
        .top-nav {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(44, 44, 46, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            display: flex;
            padding: 6px;
            gap: 8px;
            z-index: 9999;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .nav-item {
            padding: 8px 16px;
            color: var(--text-secondary, #a1a1a6);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item:hover {
            color: var(--text-primary, #f5f5f7);
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            color: white;
            background: rgba(10, 132, 255, 0.2);
            border: 1px solid rgba(10, 132, 255, 0.3);
        }

        @media (max-width: 700px) {
            .top-nav {
                top: auto;
                bottom: 20px;
                flex-wrap: wrap;
                justify-content: center;
                width: 90%;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation Layer -->
    <nav class="top-nav">
        <a href="index.html" class="nav-item" title="Menu">Menu</a>
        <a href="overview-france.html" class="nav-item">National</a>
        <a href="cosmos-bubbles.html" class="nav-item">Bulles</a>
        <a href="fragmentation-combined.html" class="nav-item">Tailles</a>
        <a href="map.html" class="nav-item active">Carte</a>
    </nav>
    <div id="sidebar">
        <div class="sidebar-header" style="padding-top: 80px;">
            <h1 class="sidebar-title">Carte RPG France</h1>
            <p class="sidebar-subtitle">Visualisation des parcelles agricoles</p>
        </div>

        <div class="sidebar-content">
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="loading-indicator">
                <div class="loading-spinner"></div>
                <span class="loading-text">Chargement des données...</span>
            </div>

            <!-- Search -->
            <div class="control-group">
                <label class="control-label">Rechercher une ville</label>
                <div class="search-container">
                    <input type="text" id="city-search" class="search-input" placeholder="Ex: Lyon, Toulouse..."
                        onkeypress="handleEnter(event)">
                    <button class="search-btn" onclick="searchCity()">Go</button>
                </div>
                <div class="city-chips">
                    <div class="chip" onclick="flyTo(48.8566, 2.3522, 11)">Paris</div>
                    <div class="chip" onclick="flyTo(45.7640, 4.8357, 11)">Lyon</div>
                    <div class="chip" onclick="flyTo(43.2965, 5.3698, 11)">Marseille</div>
                    <div class="chip" onclick="flyTo(44.8378, -0.5792, 12)">Bordeaux</div>
                    <div class="chip" onclick="flyTo(47.2184, -1.5536, 12)">Nantes</div>
                    <div class="chip" onclick="flyTo(43.6047, 1.4442, 12)">Toulouse</div>
                </div>
            </div>

            <!-- Region Filter -->
            <div class="control-group">
                <label class="control-label">Filtrer par région</label>
                <div class="region-actions">
                    <button class="region-action-btn" onclick="selectAllRegions(true)">Tout sélectionner</button>
                    <button class="region-action-btn" onclick="selectAllRegions(false)">Tout désélectionner</button>
                </div>
                <div class="region-list" id="region-container">
                    <!-- Checkboxes générées par JS -->
                </div>
            </div>

            <!-- Crop Filter -->
            <div class="control-group">
                <label class="control-label">Filtrer par culture</label>
                <div class="region-actions">
                    <button class="region-action-btn" onclick="selectAllCultures(true)">Tout sélectionner</button>
                    <button class="region-action-btn" onclick="selectAllCultures(false)">Tout désélectionner</button>
                </div>
                <div class="region-list" style="max-height: 180px;" id="culture-container">
                    <!-- Checkboxes générées par JS -->
                </div>
            </div>

            <!-- Size Filter -->
            <div class="control-group">
                <label class="control-label">Filtrer par taille</label>
                <div class="region-actions">
                    <button class="region-action-btn" onclick="selectAllSizes(true)">Tout sélectionner</button>
                    <button class="region-action-btn" onclick="selectAllSizes(false)">Tout désélectionner</button>
                </div>
                <div class="region-list" style="max-height: 180px;" id="size-container">
                    <!-- Checkboxes générées par JS -->
                </div>
            </div>

            <!-- Heatmap Toggle -->
            <div class="control-group">
                <div class="toggle-container">
                    <div class="toggle-label">
                        Heatmap
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="heatmap-toggle" onchange="toggleHeatmap()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <!-- Stats -->
            <div class="control-group">
                <label class="control-label">Statistiques</label>
                <div class="stats-panel">
                    <div class="stat-row">
                        <span class="stat-label">Parcelles affichées</span>
                        <span class="stat-value" id="stat-count">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Mode d'affichage</span>
                        <span class="stat-value success" id="stat-mode">Points</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Zoom actuel</span>
                        <span class="stat-value warning" id="stat-zoom">6</span>
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="legend">
                <div class="legend-title">Légende des cultures</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981;"></div>
                    <span class="legend-label">PPH - Prairies permanentes</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b;"></div>
                    <span class="legend-label">BTH - Blé tendre</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span class="legend-label">MIS - Maïs</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8b5cf6;"></div>
                    <span class="legend-label">VRC - Vigne</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3b82f6;"></div>
                    <span class="legend-label">Autres cultures</span>
                </div>
            </div>
        </div>
    </div>

    <div id="heatmap-legend" class="legend hidden"
        style="position: absolute; right: 20px; bottom: 30px; z-index: 1000; width: 280px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <div class="legend-title">Densité des parcelles agricoles</div>
        <p style="font-size: 11px; color: var(--text-muted); margin-top: -8px; margin-bottom: 16px; line-height: 1.4;">
            Représente la concentration locale des parcelles filtrées (pondérée par leur surface).
        </p>

        <!-- Barre de gradient pour la Heatmap -->
        <div style="width: 100%;">
            <div
                style="height: 10px; border-radius: 5px; background: linear-gradient(to right, blue, lime, red); margin-bottom: 6px;">
            </div>
            <div
                style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-primary); font-weight: 500;">
                <span>Faible densité</span>
                <span>Forte densité</span>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // Configuration
        const CONFIG = {
            center: [46.603354, 1.888334],
            initialZoom: 6,
            maxZoom: 18,
            zoomThreshold: 13,
            maxPoints: 5000,
            colors: {
                "PPH": "#10b981",  // Prairies - vert
                "BTH": "#f59e0b",  // Blé - orange
                "MIS": "#ef4444",  // Maïs - rouge
                "VRC": "#8b5cf6",  // Vigne - violet
                "DEFAULT": "#3b82f6"  // Default - bleu
            }
        };

        // Noms des régions françaises
        const REGION_NAMES = [
            "Auvergne-Rhône-Alpes",
            "Bourgogne-Franche-Comté",
            "Bretagne",
            "Centre-Val de Loire",
            "Corse",
            "Grand Est",
            "Hauts-de-France",
            "Île-de-France",
            "Normandie",
            "Nouvelle-Aquitaine",
            "Occitanie",
            "Pays de la Loire",
            "Provence-Alpes-Côte d'Azur",
            "Inconnu"
        ];

        const CULTURES = [
            { code: "PPH", label: "Prairies permanentes" },
            { code: "BTH", label: "Blé tendre" },
            { code: "MIS", label: "Maïs" },
            { code: "VRC", label: "Vignes" },
            { code: "DEFAULT", label: "Autres cultures" }
        ];

        const SIZES = {
            "micro": { label: "Micro (<0.5 ha)" },
            "petite": { label: "Petite (0.5-2 ha)" },
            "moyenne": { label: "Moyenne (2-10 ha)" },
            "grande": { label: "Grande (10-50 ha)" },
            "tres_grande": { label: "Très grande (>50 ha)" }
        };

        // State
        let map;
        let geojsonLayer;
        let heatmapLayer = null;
        let isHeatmapActive = false;
        let allData = null;
        let regionsGeo = null;
        let allDataOriginalCount = 0;
        let lastZoomMode = 'point';

        // Initialize Map
        function initMap() {
            map = L.map('map', {
                center: CONFIG.center,
                zoom: CONFIG.initialZoom,
                zoomControl: true
            });

            // Fond de carte clair OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: CONFIG.maxZoom
            }).addTo(map);

            // Listen for zoom changes
            map.on('zoomend', handleZoomChange);
            map.on('moveend', updateStats);

            updateZoomStat();
        }

        // Get color for culture type
        function getColor(code) {
            return CONFIG.colors[code] || CONFIG.colors.DEFAULT;
        }

        // Initialize region checkboxes
        function initRegionCheckboxes() {
            const container = document.getElementById('region-container');
            container.innerHTML = '';

            REGION_NAMES.sort().forEach((region, index) => {
                const item = document.createElement('div');
                item.className = 'region-item';
                item.innerHTML = `
                    <input type="checkbox" id="region-${index}" value="${region}" checked onchange="updateFilters()">
                    <label for="region-${index}">${region}</label>
                `;
                container.appendChild(item);
            });
        }

        // Select/Deselect all regions
        function selectAllRegions(select) {
            const checkboxes = document.querySelectorAll('#region-container input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = select);
            updateFilters();
        }

        function initCultureCheckboxes() {
            const container = document.getElementById('culture-container');
            container.innerHTML = '';
            CULTURES.forEach((c) => {
                const item = document.createElement('div');
                item.className = 'region-item';
                item.innerHTML = `
                    <input type="checkbox" id="culture-${c.code}" value="${c.code}" checked onchange="updateFilters()">
                    <label for="culture-${c.code}">${c.label}</label>
                `;
                container.appendChild(item);
            });
        }

        function selectAllCultures(select) {
            const checkboxes = document.querySelectorAll('#culture-container input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = select);
            updateFilters();
        }

        function initSizeCheckboxes() {
            const container = document.getElementById('size-container');
            container.innerHTML = '';
            Object.entries(SIZES).forEach(([key, val]) => {
                const item = document.createElement('div');
                item.className = 'region-item';
                item.innerHTML = `
                    <input type="checkbox" id="size-${key}" value="${key}" checked onchange="updateFilters()">
                    <label for="size-${key}">${val.label}</label>
                `;
                container.appendChild(item);
            });
        }

        function selectAllSizes(select) {
            const checkboxes = document.querySelectorAll('#size-container input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = select);
            updateFilters();
        }

        // Sample features using reservoir sampling
        function sampleFeatures(features, maxCount) {
            if (features.length <= maxCount) return features;

            const result = features.slice(0, maxCount);
            for (let i = maxCount; i < features.length; i++) {
                const j = Math.floor(Math.random() * (i + 1));
                if (j < maxCount) result[j] = features[i];
            }
            return result;
        }

        // Tag parcels with region names
        function tagParcelsWithRegion() {
            if (!allData || !regionsGeo) return;

            let matches = 0;
            allData.features.forEach(feature => {
                try {
                    const center = turf.centroid(feature);
                    let found = false;

                    for (const region of regionsGeo.features) {
                        try {
                            if (turf.booleanPointInPolygon(center, region)) {
                                feature.properties.regionName = region.properties.nom;
                                found = true;
                                matches++;
                                break;
                            }
                        } catch (e) {
                            // Skip invalid geometries
                        }
                    }

                    if (!found) {
                        feature.properties.regionName = "Inconnu";
                    }
                } catch (e) {
                    feature.properties.regionName = "Inconnu";
                }
            });

            console.log(`Région tagging terminé: ${matches}/${allData.features.length} parcelles associées`);
        }

        // Load data
        async function loadData() {
            const loadingIndicator = document.getElementById('loading-indicator');

            try {
                // Load regions and parcels in parallel
                const [regionsResponse, parcelsResponse] = await Promise.all([
                    fetch('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/regions-version-simplifiee.geojson'),
                    fetch('parcels_sample_france_5000.geojson')
                ]);

                if (!regionsResponse.ok) {
                    throw new Error('Erreur lors du chargement des régions');
                }
                if (!parcelsResponse.ok) {
                    throw new Error('Erreur lors du chargement des parcelles');
                }

                regionsGeo = await regionsResponse.json();
                const parcelsData = await parcelsResponse.json();

                allDataOriginalCount = parcelsData.features.length;
                const sampledFeatures = sampleFeatures(parcelsData.features, CONFIG.maxPoints);
                allData = { ...parcelsData, features: sampledFeatures };

                // Tag parcels with regions
                tagParcelsWithRegion();

                // Hide loading indicator
                loadingIndicator.classList.add('hidden');

                // Initial render
                updateFilters();

            } catch (error) {
                console.error('Erreur de chargement:', error);
                loadingIndicator.innerHTML = `
                    <span style="color: var(--danger);">❌ ${error.message}</span>
                `;
            }
        }

        // Handle zoom change
        function handleZoomChange() {
            const zoom = map.getZoom();
            const newMode = zoom >= CONFIG.zoomThreshold ? 'polygon' : 'point';

            updateZoomStat();

            if (newMode !== lastZoomMode) {
                updateFilters();
            }
        }

        // Update stats display
        function updateZoomStat() {
            const zoom = map.getZoom();
            document.getElementById('stat-zoom').textContent = Math.round(zoom);
        }

        // Handle toggle
        function toggleHeatmap() {
            isHeatmapActive = document.getElementById('heatmap-toggle').checked;
            updateFilters();
        }

        // Update filters and redraw
        function updateFilters() {
            if (!allData) return;

            // Get selected filters
            const regionCb = document.querySelectorAll('#region-container input:checked');
            const selectedRegions = new Set(Array.from(regionCb).map(cb => cb.value));

            const cultureCb = document.querySelectorAll('#culture-container input:checked');
            const selectedCultures = new Set(Array.from(cultureCb).map(cb => cb.value));

            const sizeCb = document.querySelectorAll('#size-container input:checked');
            const selectedSizes = new Set(Array.from(sizeCb).map(cb => cb.value));

            // Determine display mode
            const zoom = map.getZoom();
            let mode = zoom >= CONFIG.zoomThreshold ? 'polygon' : 'point';
            if (isHeatmapActive) mode = 'heatmap';
            lastZoomMode = mode;

            // Update mode stat
            let modeDisplay = 'Points';
            if (mode === 'polygon') modeDisplay = 'Polygones';
            if (mode === 'heatmap') modeDisplay = 'Heatmap';
            document.getElementById('stat-mode').textContent = modeDisplay;

            // Handle Legends
            const defaultLegend = document.querySelector('.sidebar-content .legend');
            const heatmapLegend = document.getElementById('heatmap-legend');
            if (mode === 'heatmap') {
                if (defaultLegend) defaultLegend.classList.add('hidden');
                if (heatmapLegend) heatmapLegend.classList.remove('hidden');
            } else {
                if (defaultLegend) defaultLegend.classList.remove('hidden');
                if (heatmapLegend) heatmapLegend.classList.add('hidden');
            }

            // Remove existing layers
            if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
                geojsonLayer = null;
            }
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
                heatmapLayer = null;
            }

            // Filter features
            const filteredFeatures = allData.features.filter(feature => {
                const regionName = feature.properties.regionName;
                if (!selectedRegions.has(regionName)) return false;

                const code = feature.properties.culture;
                const isMappedCulture = ["PPH", "BTH", "MIS", "VRC"].includes(code);
                const mappedCode = isMappedCulture ? code : "DEFAULT";
                if (!selectedCultures.has(mappedCode)) return false;

                const surf = feature.properties.surface || 0;
                let sizeCat = "";
                if (surf < 0.5) sizeCat = "micro";
                else if (surf <= 2) sizeCat = "petite";
                else if (surf <= 10) sizeCat = "moyenne";
                else if (surf <= 50) sizeCat = "grande";
                else sizeCat = "tres_grande";

                if (!selectedSizes.has(sizeCat)) return false;

                return true;
            });

            // TOUJOURS rééchantillonner pour atteindre le quota de 5000 parcelles
            // Cela permet de maintenir un nombre constant même quand on désélectionne des régions
            let featuresToDisplay = filteredFeatures;
            if (filteredFeatures.length > CONFIG.maxPoints) {
                featuresToDisplay = sampleFeatures(filteredFeatures, CONFIG.maxPoints);
            }

            // Update count stat
            document.getElementById('stat-count').textContent = featuresToDisplay.length.toLocaleString('fr-FR');

            if (mode === 'heatmap') {
                // Generate Heatmap Data
                const heatData = [];
                featuresToDisplay.forEach(f => {
                    try {
                        const center = turf.centroid(f);
                        const coords = center.geometry.coordinates;
                        // lat, lng, intensity
                        // Increase intensity for larger parcels
                        const intensity = f.properties.surface ? Math.min(f.properties.surface / 10, 1) + 0.2 : 0.5;
                        heatData.push([coords[1], coords[0], intensity]);
                    } catch (e) {
                        // Skip invalid
                    }
                });

                heatmapLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 10,
                    gradient: { 0.4: 'blue', 0.65: 'lime', 1: 'red' }
                }).addTo(map);

            } else {
                // Point or Polygon Mode
                let dataToDisplay;
                let options = {};

                if (mode === 'point') {
                    // Convert to centroids for better performance
                    const pointsCollection = {
                        type: "FeatureCollection",
                        features: featuresToDisplay.map(f => {
                            try {
                                const center = turf.centroid(f);
                                center.properties = f.properties;
                                return center;
                            } catch (e) {
                                return null;
                            }
                        }).filter(f => f !== null)
                    };
                    dataToDisplay = pointsCollection;

                    // Canvas renderer for performance
                    const canvasRenderer = L.canvas({ padding: 0.5 });

                    options = {
                        pointToLayer: (feature, latlng) => {
                            return L.circleMarker(latlng, {
                                radius: 4,
                                fillColor: getColor(feature.properties.culture),
                                color: 'rgba(255,255,255,0.3)',
                                weight: 1,
                                opacity: 1,
                                fillOpacity: 0.85,
                                renderer: canvasRenderer
                            });
                        },
                        onEachFeature: bindPopup
                    };
                } else {
                    // Polygon mode
                    dataToDisplay = {
                        type: "FeatureCollection",
                        features: featuresToDisplay
                    };

                    options = {
                        style: (feature) => ({
                            fillColor: getColor(feature.properties.culture),
                            weight: 2,
                            opacity: 1,
                            color: 'rgba(255,255,255,0.5)',
                            fillOpacity: 0.7
                        }),
                        onEachFeature: bindPopup
                    };
                }

                // Create and add layer
                geojsonLayer = L.geoJSON(dataToDisplay, options).addTo(map);
            }
        }

        // Bind popup and hover effects
        function bindPopup(feature, layer) {
            const p = feature.properties;

            const popupContent = `
                <div class="popup-title">${p.culture || 'Culture inconnue'}</div>
                <div class="popup-info">
                    <strong>Surface:</strong> ${p.surface ? p.surface.toFixed(2) : 'N/A'} ha<br>
                    <strong>Région:</strong> ${p.regionName || 'Inconnue'}<br>
                    <strong>ID:</strong> ${p.id || 'N/A'}
                </div>
            `;

            layer.bindPopup(popupContent);

            // Hover effects
            layer.on('mouseover', function () {
                if (lastZoomMode === 'point') {
                    this.setStyle({
                        radius: 6,
                        fillOpacity: 1,
                        weight: 2,
                        color: 'white'
                    });
                } else {
                    this.setStyle({
                        weight: 3,
                        color: 'white',
                        fillOpacity: 0.9
                    });
                }
                this.bringToFront();
            });

            layer.on('mouseout', function () {
                if (lastZoomMode === 'point') {
                    this.setStyle({
                        radius: 4,
                        fillOpacity: 0.85,
                        weight: 1,
                        color: 'rgba(255,255,255,0.3)'
                    });
                } else {
                    this.setStyle({
                        weight: 2,
                        color: 'rgba(255,255,255,0.5)',
                        fillOpacity: 0.7
                    });
                }
            });
        }

        // Update stats
        function updateStats() {
            updateZoomStat();
        }

        // Navigation functions
        function flyTo(lat, lng, zoom) {
            map.flyTo([lat, lng], zoom, {
                duration: 1.5,
                easeLinearity: 0.25
            });
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                searchCity();
            }
        }

        async function searchCity() {
            const query = document.getElementById('city-search').value.trim();
            if (!query) return;

            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}, France`;
                const response = await fetch(url);
                const results = await response.json();

                if (results.length > 0) {
                    const best = results[0];
                    flyTo(parseFloat(best.lat), parseFloat(best.lon), 12);
                } else {
                    alert('Ville non trouvée. Essayez avec un autre nom.');
                }
            } catch (error) {
                console.error('Erreur de recherche:', error);
                alert('Erreur lors de la recherche. Veuillez réessayer.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initRegionCheckboxes();
            initCultureCheckboxes();
            initSizeCheckboxes();
            loadData();
        });
    </script>
</body>

</html>